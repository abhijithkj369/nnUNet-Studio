# nnUNetv2 Training Interface

A comprehensive Gradio-based web interface for training nnUNetv2 medical image segmentation models with real-time monitoring and visualization.

![nnUNetv2 Training UI](https://img.shields.io/badge/Framework-Gradio-orange) ![Python](https://img.shields.io/badge/Python-3.8+-blue) ![nnUNet](https://img.shields.io/badge/nnUNet-v2-green)

## Features

âœ¨ **Complete Training Workflow**
- Dataset validation and structure checking
- Automatic `dataset.json` generation with label extraction
- nnUNet environment setup and preprocessing
- Full training process management

ðŸ“Š **Real-time Monitoring**
- Live training logs display
- Dynamic loss curves (train & validation)
- Dice score progression plots
- Current metrics dashboard

ðŸŽ¯ **User-Friendly Interface**
- Clean web-based UI accessible via browser
- Step-by-step workflow with three organized tabs
- No command-line expertise required
- Automatic plot updates during training

## Installation

### Prerequisites

- Python 3.8 or higher
- Windows OS (can be adapted for Linux/Mac)
- CUDA-capable GPU (recommended for training)

### Setup Steps

1. **Clone or navigate to the project directory:**
```bash
cd d:\CDAC\nnUNet_Tool
```

2. **Activate the virtual environment:**
```bash
.\venv\Scripts\activate
```

3. **Install dependencies:**
```bash
pip install -r requirements.txt
```

4. **Verify nnUNetv2 installation:**
```bash
nnUNetv2_plan_and_preprocess --help
```

If nnUNetv2 is not installed, install it:
```bash
pip install nnunetv2
```

## Dataset Preparation

Your dataset must follow the nnUNet format:

```
YourDataset/
â”œâ”€â”€ imagesTr/
â”‚   â”œâ”€â”€ case_0000_0000.nii.gz  # First case, first channel
â”‚   â”œâ”€â”€ case_0000_0001.nii.gz  # First case, second channel (if multi-modal)
â”‚   â”œâ”€â”€ case_0001_0000.nii.gz  # Second case
â”‚   â””â”€â”€ ...
â”œâ”€â”€ labelsTr/
â”‚   â”œâ”€â”€ case_0000.nii.gz  # Segmentation mask for first case
â”‚   â”œâ”€â”€ case_0001.nii.gz
â”‚   â””â”€â”€ ...
â””â”€â”€ dataset.json  # (Will be auto-generated by the UI)
```

**Requirements:**
- Images and labels must be in `.nii.gz` format
- Image filenames end with channel identifier (e.g., `_0000`)
- Label filenames match case IDs without channel suffix
- Labels must be integer-valued (0 for background, 1, 2, 3... for classes)

## Usage

### Starting the Application

1. Activate the virtual environment:
```bash
.\venv\Scripts\activate
```

2. Run the application:
```bash
python app.py
```

3. Open your browser and navigate to:
```
http://localhost:7860
```

### Workflow

#### **Tab 1: Dataset Preparation**

1. **Validate Dataset:**
   - Enter path to your dataset folder
   - Click "Validate Dataset Structure"
   - Verify that imagesTr and labelsTr are detected

2. **Generate dataset.json:**
   - Enter dataset name (e.g., "LiverSegmentation")
   - Provide description
   - Optionally specify modality names (e.g., "CT, MRI")
   - Click "Generate dataset.json"
   - Review the generated JSON

#### **Tab 2: Training Configuration**

1. **Configure Paths:**
   - Set `nnUNet_raw` (where datasets are stored)
   - Set `nnUNet_preprocessed` (preprocessed data location)
   - Set `nnUNet_results` (model checkpoints location)

2. **Set Training Parameters:**
   - Dataset ID (e.g., 1 for Dataset001)
   - Number of epochs
   - Fold to train (0-4)
   - Configuration type (3d_fullres, 2d, etc.)

3. **Setup & Preprocess:**
   - Click "Setup Training Environment"
   - Click "Run Preprocessing" (may take several minutes)

#### **Tab 3: Training & Monitoring**

1. **Start Training:**
   - Click "Start Training"
   - Monitor live logs in real-time
   - Watch loss curves and dice scores update automatically

2. **Stop Training:**
   - Click "Stop Training" if needed

## Configuration

Edit `config.py` to customize default settings:

```python
# Default paths
DEFAULT_NNUNET_RAW = "./nnUNet_raw"
DEFAULT_NNUNET_PREPROCESSED = "./nnUNet_preprocessed"
DEFAULT_NNUNET_RESULTS = "./nnUNet_results"

# Training defaults
DEFAULT_EPOCHS = 100
DEFAULT_DATASET_ID = 1
```

## Troubleshooting

### Common Issues

**1. nnUNetv2 not found**
```bash
pip install nnunetv2
```

**2. CUDA out of memory**
- Reduce batch size (nnUNet auto-configures, but you can modify plans)
- Use a smaller configuration (e.g., 3d_lowres instead of 3d_fullres)

**3. Dataset validation fails**
- Ensure folders are named exactly `imagesTr` and `labelsTr`
- Verify all files are `.nii.gz` format
- Check that image files have channel suffixes (e.g., `_0000`)

**4. Preprocessing takes too long**
- This is normal for large datasets
- nnUNet performs intensity normalization and resampling
- Check the logs for progress

**5. Plots not updating**
- The metrics parser looks for specific patterns in logs
- Some nnUNet versions may have different log formats
- Check `backend/metrics_parser.py` and adjust regex patterns if needed

## Project Structure

```
nnUNet_Tool/
â”œâ”€â”€ app.py                          # Main Gradio application
â”œâ”€â”€ config.py                       # Configuration settings
â”œâ”€â”€ requirements.txt                # Python dependencies
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ dataset_manager.py         # Dataset validation & JSON generation
â”‚   â”œâ”€â”€ trainer.py                 # Training process management
â”‚   â”œâ”€â”€ metrics_parser.py          # Log parsing for metrics
â”‚   â””â”€â”€ plotter.py                 # Visualization generation
â”œâ”€â”€ venv/                          # Virtual environment
â”œâ”€â”€ plots/                         # Generated plots (auto-created)
â”œâ”€â”€ nnUNet_raw/                    # Raw datasets (auto-created)
â”œâ”€â”€ nnUNet_preprocessed/           # Preprocessed data (auto-created)
â””â”€â”€ nnUNet_results/                # Model outputs (auto-created)
```

## Backend Modules

### DatasetManager
- Validates dataset structure
- Scans for cases and channels
- Extracts labels from segmentation masks
- Generates compliant `dataset.json`

### nnUNetTrainer
- Sets up environment variables
- Copies datasets to nnUNet_raw
- Runs preprocessing pipeline
- Manages training process with subprocess
- Streams logs in real-time

### MetricsParser
- Parses nnUNet log output using regex
- Extracts epochs, losses, and dice scores
- Maintains training history

### MetricsPlotter
- Creates matplotlib visualizations
- Generates loss plots
- Generates dice score plots
- Updates plots dynamically during training

## Advanced Usage

### Training Multiple Folds

To train all folds (cross-validation), run training 5 times with folds 0-4:
1. Train fold 0
2. Train fold 1
3. ...
4. Train fold 4

### Using Custom Trainers

Modify the trainer parameter in `backend/trainer.py`:
```python
trainer="nnUNetTrainer_CustomTrainer"
```

### Ensemble Inference

After training multiple folds, use nnUNet's ensemble prediction:
```bash
nnUNetv2_predict -i INPUT_FOLDER -o OUTPUT_FOLDER -d DATASET_ID -c 3d_fullres
```

## Credits

- **nnUNet**: [Isensee et al.](https://github.com/MIC-DKFZ/nnUNet)
- **Gradio**: [Gradio Team](https://gradio.app/)
- **Interface**: Custom implementation for medical imaging workflows

## License

This interface is provided as-is for educational and research purposes. Please refer to nnUNetv2's license for the underlying framework.

## Support

For issues specific to:
- **This UI**: Check the troubleshooting section above
- **nnUNetv2**: Refer to the [official nnUNet repository](https://github.com/MIC-DKFZ/nnUNet)
- **Dataset format**: See [nnUNet dataset conversion guide](https://github.com/MIC-DKFZ/nnUNet/blob/master/documentation/dataset_format.md)

---

**Happy Training! ðŸš€**
